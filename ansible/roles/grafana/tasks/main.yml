---
# Grafana Role - Deploy Grafana with Dashboards

- name: Deploy Grafana ConfigMap
  ansible.builtin.command:
    cmd: kubectl --kubeconfig={{ kubeconfig }} apply -f {{ manifests_dir }}/grafana/configmap.yaml
  register: grafana_configmap
  changed_when: "'configured' in grafana_configmap.stdout or 'created' in grafana_configmap.stdout"

- name: Sync Grafana dashboards onto NFS-backed Grafana PVC (avoids ConfigMap size limits)
  ansible.builtin.shell: |
    set -euo pipefail
    SRC="{{ grafana_dashboards_dir }}"
    DEST="{{ grafana_data_dir }}/dashboards"

    if [ ! -d "$SRC" ]; then
      echo "ERROR: dashboards directory not found: $SRC" >&2
      exit 1
    fi

    mkdir -p "$DEST"

    if command -v rsync >/dev/null 2>&1; then
      rsync -a --delete --include='*.json' --exclude='*' "$SRC/" "$DEST/"
    else
      shopt -s nullglob
      rm -f "$DEST"/*.json
      for f in "$SRC"/*.json; do
        cp -f "$f" "$DEST/"
      done
    fi

    chown -R 472:472 "$DEST"
    find "$DEST" -type f -name '*.json' -exec chmod 0644 {} \;
    find "$DEST" -type d -exec chmod 0755 {} \;
  args:
    executable: /bin/bash
  register: grafana_dashboards_sync
  changed_when: true

- name: Deploy Grafana Deployment
  ansible.builtin.command:
    cmd: kubectl --kubeconfig={{ kubeconfig }} apply -f {{ manifests_dir }}/grafana/deployment.yaml
  register: grafana_deployment
  changed_when: "'configured' in grafana_deployment.stdout or 'created' in grafana_deployment.stdout"

- name: Deploy Grafana Service
  ansible.builtin.command:
    cmd: kubectl --kubeconfig={{ kubeconfig }} apply -f {{ manifests_dir }}/grafana/service.yaml
  register: grafana_service
  changed_when: "'configured' in grafana_service.stdout or 'created' in grafana_service.stdout"

- name: Wait for Grafana to be ready
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod
      -l app=grafana -n {{ monitoring_namespace }} --timeout=60s
  register: grafana_status
  retries: "{{ grafana_wait_retries }}"
  delay: "{{ grafana_wait_delay }}"
  until: grafana_status.rc == 0
  changed_when: false
  failed_when: false

- name: Display Grafana deployment status
  ansible.builtin.debug:
    msg: "Grafana deployment: {{ 'Ready' if grafana_status.rc == 0 else 'Pending - check logs' }}"
