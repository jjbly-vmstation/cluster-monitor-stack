---
# Run preflight checks before deploying monitoring
- import_playbook: preflight-monitoring.yaml
# =============================================================================
# =============================================================================
# VMStation Monitoring Stack Deployment
# =============================================================================
# Deploy complete monitoring stack using Kustomize
#
# Usage:
#   ansible-playbook -i /srv/vmstation-org/cluster-setup/ansible/inventory/hosts.yml playbooks/deploy-monitoring-stack.yaml
#
# =============================================================================

- name: "Deploy VMStation Enterprise Monitoring Stack"
  hosts: monitoring_nodes
  gather_facts: true
  become: true
  vars:
    manifests_dir: "{{ playbook_dir }}/../../manifests"
    kubeconfig: "/etc/kubernetes/admin.conf"
  
  tasks:
    - name: "Display deployment banner"
      ansible.builtin.debug:
        msg: |
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          VMStation Monitoring Stack Deployment
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          Components:
          - Prometheus (metrics time-series database)
          - Grafana (dashboards and visualization)
          - Loki (log aggregation)
          - Promtail (log shipper)
          - Kube-state-metrics (K8s object metrics)
          - Node-exporter (system metrics)
          - Blackbox-exporter (probes)
          - IPMI-exporter (hardware monitoring)
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    # =============================================================================
    # Pre-deployment Validation
    # =============================================================================
    
    - name: "Verify Kubernetes cluster is accessible"
      ansible.builtin.command:
        cmd: kubectl --kubeconfig={{ kubeconfig }} cluster-info
      register: cluster_info
      changed_when: false
      failed_when: cluster_info.rc != 0

    - name: "Display cluster information"
      ansible.builtin.debug:
        msg: "{{ cluster_info.stdout_lines }}"

    - name: "Check node resources"
      ansible.builtin.shell: |
        set -o pipefail
        echo "Total Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Available Memory: $(free -h | grep Mem | awk '{print $7}')"
        echo "CPU Cores: $(nproc)"
      args:
        executable: /bin/bash
      register: node_resources
      changed_when: false

    - name: "Display node resources"
      ansible.builtin.debug:
        msg: "{{ node_resources.stdout_lines }}"

    # =============================================================================
    # Create Storage Directories
    # =============================================================================
    
    - name: "Create monitoring data directories with proper permissions"
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        mode: '0755'
        owner: "{{ item.owner | default('root') }}"
        group: "{{ item.group | default('root') }}"
      loop:
        - { path: '/srv/monitoring_data' }
        - { path: '/srv/monitoring_data/grafana', owner: '472', group: '472' }
        - { path: '/srv/monitoring_data/prometheus', owner: '65534', group: '65534' }
        - { path: '/srv/monitoring_data/loki', owner: '10001', group: '10001' }
        - { path: '/srv/monitoring_data/promtail', owner: '0', group: '0' }

    # =============================================================================
    # Deploy Monitoring Stack using Kustomize
    # =============================================================================
    
    - name: "Deploy monitoring stack using Kustomize"
      ansible.builtin.command:
        cmd: kubectl --kubeconfig={{ kubeconfig }} apply -k {{ manifests_dir }}
      register: deploy_result
      changed_when: "'configured' in deploy_result.stdout or 'created' in deploy_result.stdout"

    - name: "Display deployment result"
      ansible.builtin.debug:
        msg: "{{ deploy_result.stdout_lines }}"

    # =============================================================================
    # Wait for Core Components
    # =============================================================================
    
    - name: "Wait for Prometheus to be ready (180s)"
      ansible.builtin.command:
        cmd: >
          kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod
          -l app.kubernetes.io/name=prometheus -n monitoring --timeout=180s
      register: prometheus_ready
      changed_when: false
      failed_when: false

    - name: "Wait for Loki to be ready (180s)"
      ansible.builtin.command:
        cmd: >
          kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod
          -l app.kubernetes.io/name=loki -n monitoring --timeout=180s
      register: loki_ready
      changed_when: false
      failed_when: false

    - name: "Wait for Grafana to be ready (60s)"
      ansible.builtin.command:
        cmd: >
          kubectl --kubeconfig={{ kubeconfig }} wait --for=condition=ready pod
          -l app=grafana -n monitoring --timeout=60s
      register: grafana_ready
      changed_when: false
      failed_when: false

    # =============================================================================
    # Verification
    # =============================================================================
    
    - name: "Get all monitoring pods"
      ansible.builtin.command:
        cmd: kubectl --kubeconfig={{ kubeconfig }} get pods -n monitoring -o wide
      register: monitoring_pods
      changed_when: false

    - name: "Display monitoring pods"
      ansible.builtin.debug:
        msg: "{{ monitoring_pods.stdout_lines }}"

    - name: "Get all monitoring services"
      ansible.builtin.command:
        cmd: kubectl --kubeconfig={{ kubeconfig }} get svc -n monitoring
      register: monitoring_services
      changed_when: false

    - name: "Display monitoring services"
      ansible.builtin.debug:
        msg: "{{ monitoring_services.stdout_lines }}"

    # =============================================================================
    # Health Checks
    # =============================================================================
    
    - name: "Check Prometheus health"
      ansible.builtin.uri:
        url: "http://127.0.0.1:30090/-/healthy"
        method: GET
        status_code: 200
      register: prometheus_health
      failed_when: false
      changed_when: false

    - name: "Display Prometheus health status"
      ansible.builtin.debug:
        msg: "Prometheus health: {{ 'OK' if prometheus_health.status == 200 else 'FAILED' }}"

    - name: "Check Grafana health"
      ansible.builtin.uri:
        url: "http://127.0.0.1:30300/api/health"
        method: GET
        status_code: 200
      register: grafana_health
      failed_when: false
      changed_when: false

    - name: "Display Grafana health status"
      ansible.builtin.debug:
        msg: "Grafana health: {{ 'OK' if grafana_health.status == 200 else 'FAILED' }}"

    # =============================================================================
    # Summary
    # =============================================================================
    
    - name: "Display deployment summary"
      ansible.builtin.debug:
        msg: |
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          Monitoring Stack Deployment Complete
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          
          ✅ Prometheus: http://{{ ansible_default_ipv4.address }}:30090
          ✅ Grafana: http://{{ ansible_default_ipv4.address }}:30300
          ✅ Loki: http://{{ ansible_default_ipv4.address }}:31100
          
          Credentials:
          - Grafana: admin/admin (anonymous access enabled)
          
          Verification:
          kubectl get pods -n monitoring
          kubectl get svc -n monitoring
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
