---
# =============================================================================
# VMStation Grafana Dashboard Update
# =============================================================================
# Update Grafana dashboards from repository
#
# Usage:
#   ansible-playbook -i /srv/vmstation-org/cluster-setup/ansible/inventory/hosts.yml playbooks/update-grafana-dashboards.yaml
#
# =============================================================================

- name: "Update Grafana Dashboards"
  hosts: monitoring_nodes
  gather_facts: true
  become: true
  vars:
    manifests_dir: "{{ playbook_dir }}/../../manifests"
    kustomize_root: "{{ playbook_dir }}/../.."
    dashboards_dir: "{{ playbook_dir }}/../../dashboards"
    grafana_dashboards_dest_dir: "/srv/monitoring_data/grafana/dashboards"
    grafana_dashboards_render_script: "{{ playbook_dir }}/../../scripts/render_grafana_dashboards.py"
    kubeconfig: "/etc/kubernetes/admin.conf"
    monitoring_namespace: monitoring
  
  tasks:
    - name: "Display dashboard update banner"
      ansible.builtin.debug:
        msg: |
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          Grafana Dashboard Update
          - Sync dashboard JSON files onto Grafana PVC (NFS)
          - Restart Grafana to load changes
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    # =============================================================================
    # List Available Dashboards
    # =============================================================================
    
    - name: "Find dashboard files"
      ansible.builtin.find:
        paths: "{{ dashboards_dir }}"
        patterns: "*.json"
      register: dashboard_files
      delegate_to: masternode
      run_once: true

    - name: "Display available dashboards"
      ansible.builtin.debug:
        msg: "Found {{ dashboard_files.files | length }} dashboard files: {{ dashboard_files.files | map(attribute='path') | map('basename') | list | join(', ') }}"

    # =============================================================================
    # Sync Dashboards onto NFS-backed Grafana PVC
    # =============================================================================

    - name: "Ensure Grafana dashboards directory exists"
      ansible.builtin.file:
        path: "{{ grafana_dashboards_dest_dir }}"
        state: directory
        mode: '0755'
        owner: '472'
        group: '472'
      delegate_to: masternode
      run_once: true

    - name: "Render + sync dashboard JSON files into Grafana dashboards directory"
      ansible.builtin.shell: |
        set -euo pipefail
        SRC="{{ dashboards_dir }}"
        DEST="{{ grafana_dashboards_dest_dir }}"
        RENDER="{{ grafana_dashboards_render_script }}"

        if [ ! -d "$SRC" ]; then
          echo "ERROR: dashboards directory not found: $SRC" >&2
          exit 1
        fi

        if [ ! -f "$RENDER" ]; then
          echo "ERROR: render script not found: $RENDER" >&2
          exit 1
        fi

        mkdir -p "$DEST"
        python3 "$RENDER" --src "$SRC" --dest "$DEST" --clean

        chown -R 472:472 "$DEST"
        find "$DEST" -type f -name '*.json' -exec chmod 0644 {} \;
        find "$DEST" -type d -exec chmod 0755 {} \;

        COUNT=$(find "$DEST" -maxdepth 1 -type f -name '*.json' | wc -l | tr -d ' ')
        echo "Dashboards copied: $COUNT"
        if [ "$COUNT" -lt 1 ]; then
          echo "ERROR: No dashboard JSON files found in $DEST after sync" >&2
          exit 1
        fi
      args:
        executable: /bin/bash
      register: dashboards_sync
      changed_when: true
      delegate_to: masternode
      run_once: true

    - name: "Display dashboard sync result"
      ansible.builtin.debug:
        msg: "Dashboards synced to {{ grafana_dashboards_dest_dir }}"
      delegate_to: masternode
      run_once: true

    # =============================================================================
    # Restart Grafana to Load New Dashboards
    # =============================================================================
    
    - name: "Restart Grafana deployment to pick up new dashboards"
      ansible.builtin.command:
        cmd: kubectl --kubeconfig={{ kubeconfig }} rollout restart deployment/grafana -n {{ monitoring_namespace }}
      register: grafana_restart
      changed_when: true

    - name: "Wait for Grafana rollout to complete"
      ansible.builtin.command:
        cmd: kubectl --kubeconfig={{ kubeconfig }} rollout status deployment/grafana -n {{ monitoring_namespace }} --timeout=120s
      register: grafana_rollout
      changed_when: false

    - name: "Verify dashboards directory and provisioning mounts in Grafana pod"
      ansible.builtin.shell: |
        set -euo pipefail
        kubectl --kubeconfig={{ kubeconfig }} -n {{ monitoring_namespace }} exec deploy/grafana -- sh -c "
          echo '== datasources =='; ls -la /etc/grafana/provisioning/datasources; echo;
          echo '== dashboard providers =='; ls -la /etc/grafana/provisioning/dashboards; echo;
          echo '== dashboards json count =='; find /var/lib/grafana/dashboards -maxdepth 1 -type f -name '*.json' | wc -l
        "
      args:
        executable: /bin/bash
      register: grafana_verify
      retries: 5
      delay: 5
      until: grafana_verify.rc == 0
      changed_when: false
      delegate_to: masternode
      run_once: true

    - name: "Show Grafana logs for provisioning errors (last 200 lines)"
      ansible.builtin.shell: |
        set -euo pipefail
        kubectl --kubeconfig={{ kubeconfig }} -n {{ monitoring_namespace }} logs -l app=grafana --tail=200 | \
          grep -i -E 'provision|datasour|dashboard|error|warn' || true
      args:
        executable: /bin/bash
      register: grafana_logs_provisioning
      changed_when: false
      delegate_to: masternode
      run_once: true

    - name: "Display Grafana provisioning log highlights"
      ansible.builtin.debug:
        msg: "{{ grafana_logs_provisioning.stdout_lines | default(['(no provisioning-related log lines found)']) }}"

    # =============================================================================
    # Verification
    # =============================================================================
    
    - name: "Check Grafana health"
      ansible.builtin.uri:
        url: "http://127.0.0.1:30300/api/health"
        method: GET
        status_code: 200
      register: grafana_health
      retries: 5
      delay: 10
      until: grafana_health.status == 200
      failed_when: false

    - name: "Display update summary"
      ansible.builtin.debug:
        msg: |
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
          Dashboard Update Complete
          
          Dashboards updated: {{ dashboard_files.files | length }}
          Grafana status: {{ 'Healthy' if grafana_health.status == 200 else 'Check logs' }}
          
          Access Grafana:
          http://{{ ansible_default_ipv4.address }}:30300
          ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
