# VMStation Monitoring Stack - Kustomization
# Use with: kubectl apply -k manifests/
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

# Use `labels` (replacement for deprecated `commonLabels`) so kustomize
# applies labels consistently without causing selector mismatches.
labels:
- includeSelectors: true 
  pairs:
    app.kubernetes.io/part-of: vmstation-monitoring-stack
    vmstation.io/managed-by: kustomize

# Resources to include
resources:
  # Namespace
  - namespace.yaml
  
  # Prometheus
  - prometheus/rbac.yaml
  - prometheus/configmap.yaml
  - prometheus/deployment.yaml
  - prometheus/service.yaml
  
  # Grafana
  - grafana/configmap.yaml
  - grafana/deployment.yaml
  - grafana/service.yaml
  
  # Loki
  - loki/configmap.yaml
  - loki/deployment.yaml
  - loki/service.yaml
  
  # Promtail
  - promtail/rbac.yaml
  - promtail/configmap.yaml
  - promtail/daemonset.yaml
  
  # Exporters
  - exporters/node-exporter.yaml
  - exporters/kube-state-metrics.yaml
  - exporters/blackbox-exporter.yaml
  - exporters/ipmi-exporter.yaml

# Common annotations for all resources
commonAnnotations:
  app.kubernetes.io/version: "1.0.0"

# Images - Override if needed
images:
  - name: prom/prometheus
    newTag: v2.48.0
  - name: grafana/grafana
    newTag: "10.0.0"
  - name: grafana/loki
    newTag: 2.9.4
  - name: grafana/promtail
    newTag: 2.9.2
  - name: prom/node-exporter
    newTag: v1.6.1
  - name: registry.k8s.io/kube-state-metrics/kube-state-metrics
    newTag: v2.10.0
  - name: prom/blackbox-exporter
    newTag: v0.25.0
  - name: prometheuscommunity/ipmi-exporter
    newTag: v1.6.1

# Generate the Grafana dashboards ConfigMap from repository dashboard JSON files.
# This ensures community dashboards named like `####_rev#.json` are provisioned
# automatically alongside the built-in dashboards.
configMapGenerator:
  - name: grafana-dashboards
    files:
      - ../dashboards/315_rev3.json
      - ../dashboards/1860_rev42.json
      - ../dashboards/6417_rev1.json
      - ../dashboards/7587_rev3.json
      - ../dashboards/8171_rev1.json
      - ../dashboards/10441_rev2.json
      - ../dashboards/11001_rev1.json
      - ../dashboards/11454_rev14.json
      - ../dashboards/13332_rev12.json
      - ../dashboards/13659_rev1.json
      - ../dashboards/14055_rev5.json
      - ../dashboards/14900_rev2.json
      - ../dashboards/14981_rev2.json
      - ../dashboards/15661_rev2.json
      - ../dashboards/15760_rev37.json
      - ../dashboards/coredns-dashboard.json
      - ../dashboards/ipmi-hardware-dashboard.json
      - ../dashboards/kubernetes-cluster-dashboard.json
      - ../dashboards/loki-dashboard.json
      - ../dashboards/network-latency-dashboard.json
      - ../dashboards/node-dashboard.json
      - ../dashboards/prometheus-dashboard.json
      - ../dashboards/syslog-dashboard.json
    options:
      disableNameSuffixHash: true
      labels:
        app: grafana
        app.kubernetes.io/name: grafana
        app.kubernetes.io/component: visualization
